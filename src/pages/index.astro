---
import Layout from "../layouts/Layout.astro";
import SiteHeader from "../components/SiteHeader.astro";
import SiteFooter from "../components/SiteFooter.astro";
import site from "../data/site.json";
import publications from "../data/publications.json";
import { getCollection, getEntryBySlug } from "astro:content";

const slugifyCategory = (s) => String(s || "").trim().toLowerCase().replace(/\s+/g, "-");

const about = await getEntryBySlug("pages", "about");
const research = await getEntryBySlug("pages", "research");
const blog = await getEntryBySlug("pages", "blog");
const technotes = await getEntryBySlug("pages", "technotes");
const life = await getEntryBySlug("pages", "life");

const sections = [
  { label: "About Me", href: "/about", summary: about?.data.summary },
  { label: "Research / Projects", href: "/research", summary: research?.data.summary },
  { label: "Blog", href: "/blog", summary: blog?.data.summary },
  { label: "TechNotes", href: "/technotes", summary: technotes?.data.summary },
  { label: "Life", href: "/life", summary: life?.data.summary },
].filter((section) => section.summary);

const allPosts = await getCollection("posts", ({ data }) => !data.draft);
const posts = allPosts
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf())
  .slice(0, 6);

const projects = await getCollection("projects");
const featuredProjects = [...projects]
  .sort((a, b) => a.data.title.localeCompare(b.data.title))
  .slice(0, 3);
---

<Layout title={site.name} description="Academic and engineering homepage">
  <div class="wrap">
    <SiteHeader />

    <main class="grid">
      <section class="feed">
        <article class="block">
          <div class="blockTitle sparkle-title">About Me</div>
          <p class="desc">{about?.data.summary}</p>
          <a class="more" href="/about">Read more →</a>
        </article>

        <article class="block">
          <div class="blockTitle sparkle-title">Research / Projects</div>
          <p class="desc">{research?.data.summary}</p>
          <ul class="list">
            {featuredProjects.map((project) => (
              <li>
                <a href={`/projects/${project.slug}`}>{project.data.title}</a>
                <span class="muted">
                  {" "}
                  — {project.data.role}, {project.data.affiliation} ({project.data.period})
                </span>
              </li>
            ))}
          </ul>
          <a class="more" href="/research">View all projects →</a>
        </article>

        <article class="block">
          <div class="blockTitle sparkle-title">Latest Writing</div>
          <ul class="postList">
            {posts.map((post) => (
              <li>
                <div class="postMeta">
                  <time datetime={post.data.date.toISOString()}>
                    {post.data.date.toISOString().slice(0, 10)}
                  </time>
                  <span class="dot">·</span>
                  <a class="cat" href={`/category/${slugifyCategory(post.data.category)}`}>
                    {post.data.category}
                  </a>
                </div>
                <a class="postTitle" href={`/posts/${post.slug}`}>
                  {post.data.title}
                </a>
              </li>
            ))}
          </ul>
          <div class="moreLinks">
            <a href="/blog">Blog →</a>
            <a href="/technotes">TechNotes →</a>
            <a href="/life">Life →</a>
          </div>
        </article>

        <article class="block">
          <div class="blockTitle sparkle-title">Publications</div>
          <ul class="pubList">
            {publications.map((pub) => (
              <li>
                <a class="pubCard" href={pub.href} target="_blank" rel="noopener">
                  <div class="pubBody">
                    <div class="pubMeta">
                      <span class="pubAuthors">{pub.authors}</span>
                      <span class="dot">·</span>
                      <span>{pub.venue}</span>
                      <span class="dot">·</span>
                      <span>{pub.year}</span>
                      <span class="status">{pub.status}</span>
                    </div>
                    <div class="pubTitle">{pub.title}</div>
                  </div>
                  <div class="pubMedia">
                    <img class="pubCover" src={pub.cover} alt={`${pub.title} cover`} />
                    <img class="pubFigure" src={pub.figure} alt={`${pub.title} figure`} />
                    <span class="pubBadge">↗</span>
                  </div>
                </a>
              </li>
            ))}
          </ul>
        </article>
      </section>

      <aside class="side">
        <div class="box section-surface">
          <div class="boxTitle sparkle-title">Profile</div>
          <div class="profile">
            <div class="avatar-wrap">
              <div class="cat-wrapper" aria-hidden="true">
                <svg class="cat-realistic" viewBox="0 0 200 120" xmlns="http://www.w3.org/2000/svg">
                  <defs>
                    <linearGradient id="fur-pattern" x1="0%" y1="0%" x2="100%" y2="0%">
                      <stop offset="0%" stop-color="#b9b9b9" />
                      <stop offset="25%" stop-color="#e0e0e0" />
                      <stop offset="50%" stop-color="#9a9a9a" />
                      <stop offset="75%" stop-color="#d0d0d0" />
                      <stop offset="100%" stop-color="#b0b0b0" />
                    </linearGradient>
                    <radialGradient id="fur-pattern-head" cx="50%" cy="50%" r="50%">
                      <stop offset="0%" stop-color="#ececec" />
                      <stop offset="70%" stop-color="#b6b6b6" />
                      <stop offset="100%" stop-color="#8f8f8f" />
                    </radialGradient>
                  </defs>
                  <ellipse class="cat-shadow" cx="100" cy="112" rx="42" ry="6" />
                  <g class="cat-body-group">
                    <path class="tail" d="M160,70 Q190,40 170,20" fill="none" />
                    <path class="leg back-far" d="M130,80 L135,110" />
                    <path class="leg back-near" d="M145,85 L150,115" />
                    <path class="body-core" d="M50,80 Q50,40 100,40 T160,80 L155,95 Q100,105 55,95 Z" />
                    <path class="stripe river" d="M86,44 Q92,58 86,76" />
                    <path class="stripe river" d="M102,42 Q108,58 102,76" />
                    <path class="stripe river" d="M118,44 Q124,58 118,76" />
                    <path class="stripe tabby" d="M70,52 Q85,60 70,68" />
                    <path class="stripe tabby" d="M136,56 Q150,62 136,70" />
                    <path class="white-chest" d="M50,80 Q70,80 75,100 L55,95 Z" />
                    <path class="leg front-far" d="M70,85 L65,110" />
                    <path class="leg front-near" d="M60,90 L55,115" />
                    <circle class="sock" cx="65" cy="112" r="4" />
                    <circle class="sock" cx="55" cy="117" r="4" />
                    <circle class="sock" cx="135" cy="120" r="4" />
                    <circle class="sock" cx="125" cy="112" r="4" />
                    <g class="head">
                      <circle cx="50" cy="60" r="25" class="head-fill" />
                      <path d="M35,45 L25,25 L45,40 Z" class="ear ear-left" />
                      <path d="M65,45 L75,25 L55,40 Z" class="ear ear-right" />
                      <circle cx="50" cy="70" r="12" class="muzzle" />
                      <circle class="eye" cx="40" cy="58" r="4" />
                      <circle class="eye" cx="60" cy="58" r="4" />
                      <circle class="pupil" cx="40" cy="58" r="2" />
                      <circle class="pupil" cx="60" cy="58" r="2" />
                      <path d="M48,70 L52,70 L50,73 Z" class="nose" />
                      <g class="whiskers">
                        <line x1="32" y1="64" x2="16" y2="60" />
                        <line x1="32" y1="68" x2="14" y2="68" />
                        <line x1="32" y1="72" x2="16" y2="76" />
                        <line x1="68" y1="64" x2="84" y2="60" />
                        <line x1="68" y1="68" x2="86" y2="68" />
                        <line x1="68" y1="72" x2="84" y2="76" />
                      </g>
                    </g>
                  </g>
                </svg>
              </div>
              <img class="avatar" src="/images/ID.jpg" alt={`${site.name} portrait`} />
            </div>
            <div>
              <p class="muted name">{site.name}</p>
              <p class="muted">{site.tagline}</p>
              <p class="muted">{site.location}</p>
            </div>
          </div>
        </div>

        <div class="box">
          <div class="boxTitle">Sections</div>
          <ul class="list">
            {sections.map((section) => (
              <li>
                <a href={section.href}>{section.label}</a>
                <div class="hint">{section.summary}</div>
              </li>
            ))}
          </ul>
        </div>

        <div class="box">
          <div class="boxTitle">Contact</div>
          <ul class="list">
            {site.social.map((item) => (
              <li>
                <a href={item.href} target={item.href.startsWith("http") ? "_blank" : undefined}>
                  {item.label}
                </a>
              </li>
            ))}
          </ul>
        </div>
      </aside>
    </main>

    <SiteFooter />
  </div>

  <style>
    .wrap {
      max-width: var(--max);
      margin: 0 auto;
      width: 100%;
    }

    .grid {
      display: grid;
      grid-template-columns: minmax(0, 1fr) 340px;
      gap: 44px;
      align-items: start;
    }

    @media (max-width: 980px) {
      .grid { grid-template-columns: 1fr; gap: 26px; }
    }

    .block {
      padding: 18px 0;
      border-bottom: 1px solid var(--border);
    }

    .blockTitle {
      font-family: ui-sans-serif, system-ui;
      font-weight: 650;
      font-size: 12px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      margin-bottom: 8px;
      color: var(--muted2);
    }

    .desc { margin: 0 0 10px; color: var(--muted); font-size: 15px; }

    .postList { list-style: none; margin: 0; padding: 0; }
    .postList li { padding: 10px 0; border-bottom: 1px solid var(--border); }

    .postMeta { color: var(--muted); font-family: ui-sans-serif, system-ui; font-size: 12px; }
    .dot { margin: 0 8px; }
    .cat { text-decoration: none; border-bottom: 1px solid transparent; }
    .cat:hover { border-color: currentColor; }

    .postTitle { display: inline-block; margin-top: 6px; text-decoration: none; font-size: 18px; }
    .postTitle:hover { text-decoration: underline; }

    .more {
      display: inline-block;
      margin-top: 10px;
      font-family: ui-sans-serif, system-ui;
      text-decoration: none;
      border-bottom: 1px solid var(--border);
      padding-bottom: 2px;
    }

    .more:hover { border-color: var(--text); }

    .moreLinks {
      display: flex;
      gap: 12px;
      margin-top: 10px;
      font-family: ui-sans-serif, system-ui;
    }

    .moreLinks a { text-decoration: none; border-bottom: 1px solid var(--border); padding-bottom: 2px; }
    .moreLinks a:hover { border-color: var(--text); }

    .side { position: sticky; top: 18px; align-self: start; }
    @media (max-width: 980px) { .side { position: static; } }

    .box { border: 1px solid var(--border); padding: 14px; margin-bottom: 14px; }
    .boxTitle {
      font-family: ui-sans-serif, system-ui;
      font-weight: 650;
      font-size: 12px;
      letter-spacing: .10em;
      text-transform: uppercase;
      margin-bottom: 10px;
      color: var(--muted2);
    }

    .muted { color: var(--muted); margin: 0 0 8px; font-size: 14px; }
    .profile {
      display: grid;
      grid-template-columns: 92px 1fr;
      gap: 12px;
      align-items: center;
    }
    .avatar-wrap {
      position: relative;
      width: 92px;
      height: 92px;
    }
    .avatar {
      width: 92px;
      height: 92px;
      border-radius: 18px;
      object-fit: cover;
      border: 1px solid var(--border);
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.08);
    }
    .cat-wrapper {
      position: absolute;
      top: -56px;
      left: -90px;
      width: 160px;
      height: 110px;
      z-index: 2;
      animation: cat-sequence 10s infinite ease-in-out;
      transform-origin: bottom center;
    }
    .cat-realistic { width: 100%; height: 100%; overflow: visible; }
    .cat-shadow { fill: rgba(0, 0, 0, 0.08); }
    .body-core { fill: url(#fur-pattern); }
    .white-chest, .sock, .muzzle { fill: #ffffff; }
    .head-fill { fill: url(#fur-pattern-head); }
    .stripe { fill: none; stroke: #7f8c8d; stroke-width: 3; stroke-linecap: round; }
    .tail { stroke: #7f8c8d; stroke-width: 8; stroke-linecap: round; }
    .leg { stroke: #95a5a6; stroke-width: 6; stroke-linecap: round; }
    .back-near, .front-near { stroke: #bdc3c7; stroke-width: 7; }
    .ear { fill: #9aa0a6; }
    .eye { fill: #f3cf6e; }
    .pupil { fill: #111; }
    .nose { fill: #f2a0b6; }
    .whiskers line { stroke: #6b6f78; stroke-width: 1.5; }
    .cat-body-group { transform-origin: 100px 110px; animation: body-bob 10s infinite ease-in-out; }
    .head { transform-origin: 50px 60px; animation: head-tilt 10s infinite ease-in-out; }
    .tail { transform-origin: 160px 70px; animation: tail-swish 10s infinite ease-in-out; }
    .ear-left { animation: ear-twitch 10s infinite ease-in-out; transform-origin: 30px 45px; }
    .ear-right { animation: ear-twitch 10s infinite ease-in-out 0.2s; transform-origin: 70px 45px; }
    .whiskers { animation: whisker-twitch 10s infinite ease-in-out; }
    .leg { transform-origin: top center; animation: walk-cycle 10s infinite ease-in-out; }
    .back-near, .front-far { animation-delay: 0.3s; }
    .knead { animation: knead 10s infinite ease-in-out; }

    @keyframes cat-sequence {
      0% { transform: translateX(-30px); opacity: 0; }
      6% { opacity: 1; }
      30% { transform: translateX(140px) rotate(0deg); }
      36% { transform: translateX(140px) rotate(0deg); }
      40% { transform: translateX(148px) translateY(28px) rotate(85deg); }
      44% { transform: translateX(152px) translateY(30px) rotate(80deg); }
      48% { transform: translateX(146px) translateY(26px) rotate(88deg); }
      52% { transform: translateX(152px) translateY(30px) rotate(80deg); }
      56% { transform: translateX(148px) translateY(0) rotate(0deg); }
      66% { transform: translateX(148px); }
      100% { transform: translateX(320px); opacity: 0; }
    }

    @keyframes body-bob {
      0%, 30% { transform: translateY(0); }
      15% { transform: translateY(-3px); }
      30%, 66% { transform: translateY(0); }
      80% { transform: translateY(-2px); }
      100% { transform: translateY(0); }
    }

    @keyframes walk-cycle {
      0%, 30% { transform: rotate(-15deg); }
      15% { transform: rotate(15deg); }
      30%, 60% { transform: rotate(0deg); }
      80% { transform: rotate(-12deg); }
      100% { transform: rotate(12deg); }
    }

    @keyframes tail-swish {
      0%, 30% { transform: rotate(-8deg); }
      15% { transform: rotate(14deg); }
      40% { transform: rotate(6deg); }
      60% { transform: rotate(18deg); }
      100% { transform: rotate(-6deg); }
    }

    @keyframes head-tilt {
      0%, 30% { transform: rotate(0deg); }
      36% { transform: rotate(-6deg); }
      44% { transform: rotate(8deg) translateX(2px); }
      48% { transform: rotate(6deg) translateX(-2px); }
      56% { transform: rotate(0deg); }
      100% { transform: rotate(2deg); }
    }

    @keyframes ear-twitch {
      0%, 34% { transform: rotate(0deg); }
      38% { transform: rotate(-6deg); }
      42% { transform: rotate(0deg); }
      100% { transform: rotate(0deg); }
    }

    @keyframes whisker-twitch {
      0%, 40% { transform: translateY(0); }
      44% { transform: translateY(-1px); }
      48% { transform: translateY(0); }
      100% { transform: translateY(0); }
    }

    @keyframes knead {
      0%, 40% { transform: translateY(0); }
      44% { transform: translateY(2px); }
      48% { transform: translateY(0); }
      52% { transform: translateY(2px); }
      56% { transform: translateY(0); }
      100% { transform: translateY(0); }
    }
    .name { font-weight: 600; color: var(--text); }
    .list { margin: 0; padding-left: 18px; color: var(--muted); }
    .list a { text-decoration: none; border-bottom: 1px solid transparent; }
    .list a:hover { border-color: currentColor; }

    .hint {
      font-size: 12px;
      color: var(--muted2);
      margin-top: 4px;
    }

    .pubList { list-style: none; margin: 0; padding: 0; }
    .pubList li { padding: 10px 0; border-bottom: 1px solid var(--border); }
    .pubCard {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      text-decoration: none;
      color: inherit;
    }
    .pubMedia {
      position: relative;
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      background: #f7f7f7;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.06);
      display: grid;
      gap: 0;
      transition: box-shadow 0.15s ease;
    }
    .pubCover,
    .pubFigure {
      width: 100%;
      height: auto;
      object-fit: cover;
      display: block;
      transform: scale(0.98);
      transition: transform 0.2s ease;
    }
    .pubCover { filter: saturate(0.95); }
    .pubFigure { border-top: 1px solid rgba(0, 0, 0, 0.08); }
    .pubBadge {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: rgba(17, 17, 17, 0.75);
      color: #fff;
      font-size: 12px;
      display: grid;
      place-items: center;
    }
    .pubCard:hover .pubMedia {
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
      transform: translateY(-1px);
      transition: box-shadow 0.15s ease, transform 0.15s ease;
    }
    .pubCard:hover .pubCover,
    .pubCard:hover .pubFigure {
      transform: scale(1.03);
    }
    .pubBody { display: grid; gap: 6px; }
    .pubMeta { color: var(--muted); font-family: ui-sans-serif, system-ui; font-size: 12px; }
    .pubAuthors { font-weight: 600; color: var(--text); }
    .status { margin-left: 8px; font-weight: 600; color: var(--text); }
    .pubTitle { font-size: 18px; line-height: 1.35; }
  </style>
</Layout>
