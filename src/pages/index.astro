---
import Layout from "../layouts/Layout.astro";
import SiteHeader from "../components/SiteHeader.astro";
import SiteFooter from "../components/SiteFooter.astro";
import site from "../data/site.json";
import publications from "../data/publications.json";
import { getCollection, getEntryBySlug } from "astro:content";

const slugifyCategory = (s) => String(s || "").trim().toLowerCase().replace(/\s+/g, "-");

const about = await getEntryBySlug("pages", "about");
const research = await getEntryBySlug("pages", "research");
const blog = await getEntryBySlug("pages", "blog");
const technotes = await getEntryBySlug("pages", "technotes");
const life = await getEntryBySlug("pages", "life");

const sections = [
  { label: "About Me", href: "/about", summary: about?.data.summary },
  { label: "Research / Projects", href: "/research", summary: research?.data.summary },
  { label: "Blog", href: "/blog", summary: blog?.data.summary },
  { label: "TechNotes", href: "/technotes", summary: technotes?.data.summary },
  { label: "Life", href: "/life", summary: life?.data.summary },
].filter((section) => section.summary);

const allPosts = await getCollection("posts", ({ data }) => !data.draft);
const posts = allPosts
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf())
  .slice(0, 6);

const projects = await getCollection("projects");
const featuredProjects = [...projects]
  .sort((a, b) => a.data.title.localeCompare(b.data.title))
  .slice(0, 3);
---

<Layout title={site.name} description="Academic and engineering homepage">
  <div class="wrap">
    <SiteHeader />

    <main class="grid">
      <section class="feed">
        <article class="block">
          <div class="blockTitle sparkle-title">About Me</div>
          <p class="desc">{about?.data.summary}</p>
          <a class="more" href="/about">Read more →</a>
        </article>

        <article class="block">
          <div class="blockTitle sparkle-title">Research / Projects</div>
          <p class="desc">{research?.data.summary}</p>
          <ul class="list">
            {featuredProjects.map((project) => (
              <li>
                <a href={`/projects/${project.slug}`}>{project.data.title}</a>
                <span class="muted">
                  {" "}
                  — {project.data.role}, {project.data.affiliation} ({project.data.period})
                </span>
              </li>
            ))}
          </ul>
          <a class="more" href="/research">View all projects →</a>
        </article>

        <article class="block">
          <div class="blockTitle sparkle-title">Latest Writing</div>
          <ul class="postList">
            {posts.map((post) => (
              <li>
                <div class="postMeta">
                  <time datetime={post.data.date.toISOString()}>
                    {post.data.date.toISOString().slice(0, 10)}
                  </time>
                  <span class="dot">·</span>
                  <a class="cat" href={`/category/${slugifyCategory(post.data.category)}`}>
                    {post.data.category}
                  </a>
                </div>
                <a class="postTitle" href={`/posts/${post.slug}`}>
                  {post.data.title}
                </a>
              </li>
            ))}
          </ul>
          <div class="moreLinks">
            <a href="/blog">Blog →</a>
            <a href="/technotes">TechNotes →</a>
            <a href="/life">Life →</a>
          </div>
        </article>

        <article class="block">
          <div class="blockTitle sparkle-title">Publications</div>
          <ul class="pubList">
            {publications.map((pub) => (
              <li>
                <a class="pubCard" href={pub.href} target="_blank" rel="noopener">
                  <div class="pubBody">
                    <div class="pubMeta">
                      <span class="pubAuthors">{pub.authors}</span>
                      <span class="dot">·</span>
                      <span>{pub.venue}</span>
                      <span class="dot">·</span>
                      <span>{pub.year}</span>
                      <span class="status">{pub.status}</span>
                    </div>
                    <div class="pubTitle">{pub.title}</div>
                  </div>
                  <div class="pubMedia">
                    <img class="pubCover" src={pub.cover} alt={`${pub.title} cover`} />
                    <img class="pubFigure" src={pub.figure} alt={`${pub.title} figure`} />
                    <span class="pubBadge">↗</span>
                  </div>
                </a>
              </li>
            ))}
          </ul>
        </article>
      </section>

      <aside class="side">
        <div class="box section-surface">
          <div class="boxTitle sparkle-title">Profile</div>
          <div class="profile">
            <div class="avatar-wrap">
              <img class="avatar" src="/images/ID.jpg" alt={`${site.name} portrait`} />
            </div>
            <div>
              <p class="muted name">{site.name}</p>
              <p class="muted">{site.tagline}</p>
              <p class="muted">{site.location}</p>
            </div>
          </div>
        </div>

        <div class="box">
          <div class="boxTitle">Sections</div>
          <ul class="list">
            {sections.map((section) => (
              <li>
                <a href={section.href}>{section.label}</a>
                <div class="hint">{section.summary}</div>
              </li>
            ))}
          </ul>
        </div>

        <div class="box">
          <div class="boxTitle">Contact</div>
          <ul class="list">
            {site.social.map((item) => (
              <li>
                <a href={item.href} target={item.href.startsWith("http") ? "_blank" : undefined}>
                  {item.label}
                </a>
              </li>
            ))}
          </ul>
        </div>
      </aside>
    </main>

    <SiteFooter />
  </div>

  <style>
    .wrap {
      max-width: var(--max);
      margin: 0 auto;
      width: 100%;
    }

    .grid {
      display: grid;
      grid-template-columns: minmax(0, 1fr) 340px;
      gap: 44px;
      align-items: start;
    }

    @media (max-width: 980px) {
      .grid { grid-template-columns: 1fr; gap: 26px; }
    }

    .block {
      padding: 18px 0;
      border-bottom: 1px solid var(--border);
    }

    .blockTitle {
      font-family: ui-sans-serif, system-ui;
      font-weight: 650;
      font-size: 12px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      margin-bottom: 8px;
      color: var(--muted2);
    }

    .desc { margin: 0 0 10px; color: var(--muted); font-size: 15px; }

    .postList { list-style: none; margin: 0; padding: 0; }
    .postList li { padding: 10px 0; border-bottom: 1px solid var(--border); }

    .postMeta { color: var(--muted); font-family: ui-sans-serif, system-ui; font-size: 12px; }
    .dot { margin: 0 8px; }
    .cat { text-decoration: none; border-bottom: 1px solid transparent; }
    .cat:hover { border-color: currentColor; }

    .postTitle { display: inline-block; margin-top: 6px; text-decoration: none; font-size: 18px; }
    .postTitle:hover { text-decoration: underline; }

    .more {
      display: inline-block;
      margin-top: 10px;
      font-family: ui-sans-serif, system-ui;
      text-decoration: none;
      border-bottom: 1px solid var(--border);
      padding-bottom: 2px;
    }

    .more:hover { border-color: var(--text); }

    .moreLinks {
      display: flex;
      gap: 12px;
      margin-top: 10px;
      font-family: ui-sans-serif, system-ui;
    }

    .moreLinks a { text-decoration: none; border-bottom: 1px solid var(--border); padding-bottom: 2px; }
    .moreLinks a:hover { border-color: var(--text); }

    .side { position: sticky; top: 18px; align-self: start; }
    @media (max-width: 980px) { .side { position: static; } }

    .box { border: 1px solid var(--border); padding: 14px; margin-bottom: 14px; }
    .boxTitle {
      font-family: ui-sans-serif, system-ui;
      font-weight: 650;
      font-size: 12px;
      letter-spacing: .10em;
      text-transform: uppercase;
      margin-bottom: 10px;
      color: var(--muted2);
    }

    .muted { color: var(--muted); margin: 0 0 8px; font-size: 14px; }
    .profile {
      display: grid;
      grid-template-columns: 92px 1fr;
      gap: 12px;
      align-items: center;
    }
    .avatar-wrap {
      position: relative;
      width: 92px;
      height: 92px;
    }
    .avatar {
      width: 92px;
      height: 92px;
      border-radius: 18px;
      object-fit: cover;
      border: 1px solid var(--border);
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.08);
    }
    #cat-overlay {
      position: fixed;
      left: 0;
      top: 0;
      width: 0;
      height: 0;
      pointer-events: none;
      z-index: 50;
    }

    #sleepy-cat {
      position: absolute;
      width: 90px;
      height: 90px;
      transform-origin: 50% 80%;
      will-change: transform, left, top;
      filter: drop-shadow(0 6px 10px rgba(0, 0, 0, 0.15));
      animation: catBreath 2.8s ease-in-out infinite;
    }

    #cat-zzz {
      position: absolute;
      font-size: 14px;
      opacity: 0;
      transform: translateY(0);
      color: rgba(90, 90, 120, 0.65);
      font-weight: 600;
      letter-spacing: 0.5px;
      animation: zzzFloat 3.2s ease-in-out infinite;
    }

    @keyframes catBreath {
      0%, 100% { transform: translateY(0px) scaleY(1); }
      50% { transform: translateY(1.5px) scaleY(1.03); }
    }

    @keyframes zzzFloat {
      0% { opacity: 0; transform: translateY(6px) scale(0.98); }
      20% { opacity: 0.65; }
      55% { opacity: 0.65; transform: translateY(-8px) scale(1); }
      80% { opacity: 0; }
      100% { opacity: 0; transform: translateY(-14px) scale(1.02); }
    }
    .name { font-weight: 600; color: var(--text); }
    .list { margin: 0; padding-left: 18px; color: var(--muted); }
    .list a { text-decoration: none; border-bottom: 1px solid transparent; }
    .list a:hover { border-color: currentColor; }

    .hint {
      font-size: 12px;
      color: var(--muted2);
      margin-top: 4px;
    }

    .pubList { list-style: none; margin: 0; padding: 0; }
    .pubList li { padding: 10px 0; border-bottom: 1px solid var(--border); }
    .pubCard {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      text-decoration: none;
      color: inherit;
    }
    .pubMedia {
      position: relative;
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      background: #f7f7f7;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.06);
      display: grid;
      gap: 0;
      transition: box-shadow 0.15s ease;
    }
    .pubCover,
    .pubFigure {
      width: 100%;
      height: auto;
      object-fit: cover;
      display: block;
      transform: scale(0.98);
      transition: transform 0.2s ease;
    }
    .pubCover { filter: saturate(0.95); }
    .pubFigure { border-top: 1px solid rgba(0, 0, 0, 0.08); }
    .pubBadge {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: rgba(17, 17, 17, 0.75);
      color: #fff;
      font-size: 12px;
      display: grid;
      place-items: center;
    }
    .pubCard:hover .pubMedia {
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
      transform: translateY(-1px);
      transition: box-shadow 0.15s ease, transform 0.15s ease;
    }
    .pubCard:hover .pubCover,
    .pubCard:hover .pubFigure {
      transform: scale(1.03);
    }
    .pubBody { display: grid; gap: 6px; }
    .pubMeta { color: var(--muted); font-family: ui-sans-serif, system-ui; font-size: 12px; }
    .pubAuthors { font-weight: 600; color: var(--text); }
    .status { margin-left: 8px; font-weight: 600; color: var(--text); }
    .pubTitle { font-size: 18px; line-height: 1.35; }
  </style>

  <div id="cat-overlay" aria-hidden="true">
    <div id="sleepy-cat"></div>
    <div id="cat-zzz">Zzz</div>
  </div>

  <script src="https://unpkg.com/lottie-web/build/player/lottie.min.js"></script>

  <script is:inline>
    (function () {
      const avatarContainerSelector = ".avatar";
      const USE_LOTTIE = true;
      const LOTTIE_JSON_PATH = "/assets/anim/cat_american_shorthair.json";

      let overlay;
      let catEl;
      let zzzEl;
      let avatarEl;
      let ro;

      function clamp(value, min, max) {
        return Math.max(min, Math.min(max, value));
      }

      function ensureOverlay() {
        overlay = document.getElementById("cat-overlay");
        catEl = document.getElementById("sleepy-cat");
        zzzEl = document.getElementById("cat-zzz");
      }

      function findAvatar() {
        return document.querySelector(avatarContainerSelector);
      }

      function updatePosition() {
        avatarEl = findAvatar();
        if (!avatarEl) return;

        const box = avatarEl.getBoundingClientRect();
        const catW = clamp(box.width * 0.26, 56, 110);
        const catH = catW;

        catEl.style.width = `${catW}px`;
        catEl.style.height = `${catH}px`;

        const x = box.left + box.width * 0.5 - catW / 2;
        const y = box.top - catH * 0.35;

        catEl.style.left = `${x}px`;
        catEl.style.top = `${y}px`;
        zzzEl.style.left = `${x + catW * 0.7}px`;
        zzzEl.style.top = `${y - catH * 0.1}px`;
      }

      function initObservers() {
        if (window.ResizeObserver) {
          ro = new ResizeObserver(() => updatePosition());
          if (avatarEl) ro.observe(avatarEl);
        }
        window.addEventListener("resize", updatePosition, { passive: true });
        window.addEventListener("scroll", updatePosition, { passive: true });
      }

      function initLottie() {
        if (!USE_LOTTIE) return;
        if (!window.lottie) return;
        catEl.innerHTML = "";
        window.lottie.loadAnimation({
          container: catEl,
          renderer: "svg",
          loop: true,
          autoplay: true,
          path: LOTTIE_JSON_PATH,
        });
      }

      function initCssFallback() {
        if (USE_LOTTIE) return;
        catEl.innerHTML = `
          <svg viewBox="0 0 200 140" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">
            <path d="M40,95 C55,55 90,45 120,60 C150,75 165,95 150,110 C135,125 70,125 52,112 C42,105 38,102 40,95Z"
                  fill="rgba(170,170,175,0.9)"/>
            <path d="M70,70 C78,60 88,58 96,66" stroke="rgba(255,255,255,0.8)" stroke-width="6" stroke-linecap="round"/>
            <circle cx="92" cy="80" r="4" fill="rgba(255,255,255,0.8)"/>
            <path d="M150,96 C175,100 180,120 160,126" fill="none" stroke="rgba(150,150,160,0.9)" stroke-width="14" stroke-linecap="round"/>
          </svg>
        `;
      }

      function boot() {
        ensureOverlay();
        updatePosition();
        initObservers();
        initLottie();
        initCssFallback();
      }

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", boot);
      } else {
        boot();
      }
    })();
  </script>
</Layout>
