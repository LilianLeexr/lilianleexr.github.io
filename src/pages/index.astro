---
import Layout from "../layouts/Layout.astro";
import SiteHeader from "../components/SiteHeader.astro";
import SiteFooter from "../components/SiteFooter.astro";
import site from "../data/site.json";
import publications from "../data/publications.json";
import { getCollection, getEntryBySlug } from "astro:content";

const slugifyCategory = (s) => String(s || "").trim().toLowerCase().replace(/\s+/g, "-");

const about = await getEntryBySlug("pages", "about");
const research = await getEntryBySlug("pages", "research");
const blog = await getEntryBySlug("pages", "blog");
const technotes = await getEntryBySlug("pages", "technotes");
const life = await getEntryBySlug("pages", "life");

const sections = [
  { label: "About Me", href: "/about", summary: about?.data.summary },
  { label: "Research / Projects", href: "/research", summary: research?.data.summary },
  { label: "Blog", href: "/blog", summary: blog?.data.summary },
  { label: "TechNotes", href: "/technotes", summary: technotes?.data.summary },
  { label: "Life", href: "/life", summary: life?.data.summary },
].filter((section) => section.summary);

const allPosts = await getCollection("posts", ({ data }) => !data.draft);
const posts = allPosts
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf())
  .slice(0, 6);

const projects = await getCollection("projects");
const featuredProjects = [...projects]
  .sort((a, b) => a.data.title.localeCompare(b.data.title))
  .slice(0, 3);
---

<Layout title={site.name} description="Academic and engineering homepage">
  <div class="wrap">
    <SiteHeader />

    <main class="grid">
      <section class="feed">
        <article class="block">
          <div class="blockTitle sparkle-title">About Me</div>
          <p class="desc">{about?.data.summary}</p>
          <a class="more" href="/about">Read more →</a>
        </article>

        <article class="block">
          <div class="blockTitle sparkle-title">Research / Projects</div>
          <p class="desc">{research?.data.summary}</p>
          <ul class="list">
            {featuredProjects.map((project) => (
              <li>
                <a href={`/projects/${project.slug}`}>{project.data.title}</a>
                <span class="muted">
                  {" "}
                  — {project.data.role}, {project.data.affiliation} ({project.data.period})
                </span>
              </li>
            ))}
          </ul>
          <a class="more" href="/research">View all projects →</a>
        </article>

        <article class="block">
          <div class="blockTitle sparkle-title">Latest Writing</div>
          <ul class="postList">
            {posts.map((post) => (
              <li>
                <div class="postMeta">
                  <time datetime={post.data.date.toISOString()}>
                    {post.data.date.toISOString().slice(0, 10)}
                  </time>
                  <span class="dot">·</span>
                  <a class="cat" href={`/category/${slugifyCategory(post.data.category)}`}>
                    {post.data.category}
                  </a>
                </div>
                <a class="postTitle" href={`/posts/${post.slug}`}>
                  {post.data.title}
                </a>
              </li>
            ))}
          </ul>
          <div class="moreLinks">
            <a href="/blog">Blog →</a>
            <a href="/technotes">TechNotes →</a>
            <a href="/life">Life →</a>
          </div>
        </article>

        <article class="block">
          <div class="blockTitle sparkle-title">Publications</div>
          <ul class="pubList">
            {publications.map((pub) => (
              <li>
                <a class="pubCard" href={pub.href} target="_blank" rel="noopener">
                  <div class="pubBody">
                    <div class="pubMeta">
                      <span class="pubAuthors">{pub.authors}</span>
                      <span class="dot">·</span>
                      <span>{pub.venue}</span>
                      <span class="dot">·</span>
                      <span>{pub.year}</span>
                      <span class="status">{pub.status}</span>
                    </div>
                    <div class="pubTitle">{pub.title}</div>
                  </div>
                  <div class="pubMedia">
                    <img class="pubCover" src={pub.cover} alt={`${pub.title} cover`} />
                    <img class="pubFigure" src={pub.figure} alt={`${pub.title} figure`} />
                    <span class="pubBadge">↗</span>
                  </div>
                </a>
              </li>
            ))}
          </ul>
        </article>
      </section>

      <aside class="side">
        <div class="box section-surface">
          <div class="boxTitle sparkle-title">Profile</div>
          <div class="profile">
            <div class="avatar-wrap">
              <div class="cat-wrapper" aria-hidden="true">
                <svg class="chi-cat" viewBox="0 0 100 80" xmlns="http://www.w3.org/2000/svg">
                  <g class="cat-all">
                    <path class="cat-tail" d="M85,55 Q100,40 90,20" fill="none" />
                    <path class="body-core" d="M20,60 Q20,30 55,30 T90,60 L85,75 Q55,85 25,75 Z" />
                    <path class="stripe river" d="M45,32 Q50,45 45,58" />
                    <path class="stripe river" d="M60,31 Q65,45 60,58" />
                    <path class="stripe river" d="M75,32 Q80,45 75,58" />
                    <path class="stripe tabby" d="M34,34 L38,38 L42,34 L46,38" />
                    <path class="white-chest" d="M20,60 Q35,60 40,75 L25,75 Z" />
                    <g class="legs">
                      <rect class="leg l1" x="30" y="70" width="6" height="10" rx="3" />
                      <rect class="leg l2" x="45" y="72" width="6" height="10" rx="3" />
                      <rect class="leg l3" x="65" y="72" width="6" height="10" rx="3" />
                      <rect class="leg l4" x="80" y="70" width="6" height="10" rx="3" />
                    </g>
                    <g class="cat-head">
                      <circle cx="30" cy="45" r="22" class="head-fill" />
                      <path d="M25,28 L15,5 L35,22 Z" class="ear ear-left" />
                      <path d="M45,28 L55,5 L35,22 Z" class="ear ear-right" />
                      <path class="forehead" d="M25,30 L30,35 L35,30 L40,35" />
                      <ellipse cx="30" cy="53" rx="10" ry="7" class="muzzle" />
                      <path class="eye-open" d="M22,48 a4,4 0 1,0 8,0 a4,4 0 1,0 -8,0" />
                      <path class="eye-open" d="M38,48 a4,4 0 1,0 8,0 a4,4 0 1,0 -8,0" />
                      <path class="eye-happy" d="M20,50 Q24,45 28,50 M36,50 Q40,45 44,50" />
                      <path d="M29,55 L31,55 L30,57 Z" class="nose" />
                      <g class="whiskers">
                        <line x1="20" y1="54" x2="6" y2="50" />
                        <line x1="20" y1="58" x2="4" y2="58" />
                        <line x1="20" y1="62" x2="6" y2="66" />
                        <line x1="40" y1="54" x2="54" y2="50" />
                        <line x1="40" y1="58" x2="56" y2="58" />
                        <line x1="40" y1="62" x2="54" y2="66" />
                      </g>
                    </g>
                  </g>
                </svg>
              </div>
              <img class="avatar" src="/images/ID.jpg" alt={`${site.name} portrait`} />
            </div>
            <div>
              <p class="muted name">{site.name}</p>
              <p class="muted">{site.tagline}</p>
              <p class="muted">{site.location}</p>
            </div>
          </div>
        </div>

        <div class="box">
          <div class="boxTitle">Sections</div>
          <ul class="list">
            {sections.map((section) => (
              <li>
                <a href={section.href}>{section.label}</a>
                <div class="hint">{section.summary}</div>
              </li>
            ))}
          </ul>
        </div>

        <div class="box">
          <div class="boxTitle">Contact</div>
          <ul class="list">
            {site.social.map((item) => (
              <li>
                <a href={item.href} target={item.href.startsWith("http") ? "_blank" : undefined}>
                  {item.label}
                </a>
              </li>
            ))}
          </ul>
        </div>
      </aside>
    </main>

    <SiteFooter />
  </div>

  <style>
    .wrap {
      max-width: var(--max);
      margin: 0 auto;
      width: 100%;
    }

    .grid {
      display: grid;
      grid-template-columns: minmax(0, 1fr) 340px;
      gap: 44px;
      align-items: start;
    }

    @media (max-width: 980px) {
      .grid { grid-template-columns: 1fr; gap: 26px; }
    }

    .block {
      padding: 18px 0;
      border-bottom: 1px solid var(--border);
    }

    .blockTitle {
      font-family: ui-sans-serif, system-ui;
      font-weight: 650;
      font-size: 12px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      margin-bottom: 8px;
      color: var(--muted2);
    }

    .desc { margin: 0 0 10px; color: var(--muted); font-size: 15px; }

    .postList { list-style: none; margin: 0; padding: 0; }
    .postList li { padding: 10px 0; border-bottom: 1px solid var(--border); }

    .postMeta { color: var(--muted); font-family: ui-sans-serif, system-ui; font-size: 12px; }
    .dot { margin: 0 8px; }
    .cat { text-decoration: none; border-bottom: 1px solid transparent; }
    .cat:hover { border-color: currentColor; }

    .postTitle { display: inline-block; margin-top: 6px; text-decoration: none; font-size: 18px; }
    .postTitle:hover { text-decoration: underline; }

    .more {
      display: inline-block;
      margin-top: 10px;
      font-family: ui-sans-serif, system-ui;
      text-decoration: none;
      border-bottom: 1px solid var(--border);
      padding-bottom: 2px;
    }

    .more:hover { border-color: var(--text); }

    .moreLinks {
      display: flex;
      gap: 12px;
      margin-top: 10px;
      font-family: ui-sans-serif, system-ui;
    }

    .moreLinks a { text-decoration: none; border-bottom: 1px solid var(--border); padding-bottom: 2px; }
    .moreLinks a:hover { border-color: var(--text); }

    .side { position: sticky; top: 18px; align-self: start; }
    @media (max-width: 980px) { .side { position: static; } }

    .box { border: 1px solid var(--border); padding: 14px; margin-bottom: 14px; }
    .boxTitle {
      font-family: ui-sans-serif, system-ui;
      font-weight: 650;
      font-size: 12px;
      letter-spacing: .10em;
      text-transform: uppercase;
      margin-bottom: 10px;
      color: var(--muted2);
    }

    .muted { color: var(--muted); margin: 0 0 8px; font-size: 14px; }
    .profile {
      display: grid;
      grid-template-columns: 92px 1fr;
      gap: 12px;
      align-items: center;
    }
    .avatar-wrap {
      position: relative;
      width: 92px;
      height: 92px;
    }
    .avatar {
      width: 92px;
      height: 92px;
      border-radius: 18px;
      object-fit: cover;
      border: 1px solid var(--border);
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.08);
    }
    .cat-wrapper {
      position: absolute;
      top: -62px;
      left: -100px;
      width: 120px;
      height: 90px;
      z-index: 2;
      animation: chi-sequence 12s infinite cubic-bezier(0.175, 0.885, 0.32, 1.275);
      transform-origin: bottom center;
    }
    .chi-cat { width: 100%; height: 100%; }
    .body-core { fill: #bdc3c7; }
    .head-fill { fill: #bdc3c7; }
    .muzzle { fill: #ffffff; }
    .white-chest { fill: #ffffff; }
    .leg { fill: #ffffff; stroke: #7f8c8d; stroke-width: 0.5; }
    .stripe { fill: none; stroke: #7f8c8d; stroke-width: 2.5; opacity: 0.6; }
    .forehead { fill: none; stroke: #7f8c8d; stroke-width: 2; }
    .ear { fill: #95a5a6; }
    .eye-open { fill: #2c3e50; }
    .eye-happy { fill: none; stroke: #2c3e50; stroke-width: 2; opacity: 0; }
    .nose { fill: #ffb6c1; }
    .cat-tail { stroke: #7f8c8d; stroke-width: 5; stroke-linecap: round; }
    .whiskers line { stroke: #7f8c8d; stroke-width: 1.2; }

    .cat-all { transform-origin: 50px 75px; animation: squish 12s infinite ease-in-out; }
    .cat-head { transform-origin: 30px 45px; animation: head-tilt 12s infinite ease-in-out; }
    .cat-tail { transform-origin: 85px 55px; animation: tail-hook 12s infinite ease-in-out; }
    .whiskers { animation: whisker-twitch 12s infinite ease-in-out; }
    .ear-left { transform-origin: 25px 28px; animation: ear-twitch 12s infinite ease-in-out; }
    .ear-right { transform-origin: 45px 28px; animation: ear-twitch 12s infinite ease-in-out 0.2s; }
    .leg { transform-origin: top; animation: walk-paws 0.4s infinite alternate; }
    .l2, .l4 { animation-delay: 0.2s; }
    .l2, .l3 { animation: knead 12s infinite ease-in-out; }

    @keyframes chi-sequence {
      0% { transform: translateX(0) scaleY(1); opacity: 0; }
      6% { opacity: 1; }
      20% { transform: translateX(120px) scaleY(1); }
      25% { transform: translateX(125px) translateY(10px) rotate(75deg); }
      30% { transform: translateX(127px) translateY(8px) rotate(70deg); }
      35% { transform: translateX(123px) translateY(12px) rotate(80deg); }
      40% { transform: translateX(127px) translateY(8px) rotate(70deg); }
      45% { transform: translateX(123px) translateY(12px) rotate(80deg); }
      55% { transform: translateX(125px) translateY(0) rotate(0deg); }
      65% { transform: translateX(125px) scaleY(0.95) scaleX(1.05); }
      75% { transform: translateX(125px) scaleY(1); }
      100% { transform: translateX(300px); opacity: 0; }
    }

    @keyframes squish {
      0%, 20% { transform: scaleY(0.95); }
      10% { transform: scaleY(1.05); }
      25%, 60% { transform: scaleY(1); }
      70% { transform: scaleY(0.98); }
      100% { transform: scaleY(1); }
    }

    @keyframes walk-paws {
      from { transform: translateY(0); }
      to { transform: translateY(-4px); }
    }

    @keyframes tail-hook {
      0%, 20% { transform: rotate(-5deg); }
      40% { transform: rotate(15deg) scaleX(1.1); }
      100% { transform: rotate(5deg); }
    }

    @keyframes head-tilt {
      0%, 20% { transform: rotate(0deg); }
      24% { transform: rotate(-8deg); }
      28% { transform: rotate(0deg); }
      60% { transform: rotate(3deg); }
      70% { transform: rotate(0deg); }
    }

    @keyframes ear-twitch {
      0%, 22% { transform: rotate(0deg); }
      26% { transform: rotate(-6deg); }
      30% { transform: rotate(0deg); }
      100% { transform: rotate(0deg); }
    }

    @keyframes whisker-twitch {
      0%, 24% { transform: translateY(0); }
      28% { transform: translateY(-1px); }
      32% { transform: translateY(0); }
      100% { transform: translateY(0); }
    }

    @keyframes knead {
      0%, 40% { transform: translateY(0); }
      44% { transform: translateY(2px); }
      48% { transform: translateY(0); }
      52% { transform: translateY(2px); }
      56% { transform: translateY(0); }
      100% { transform: translateY(0); }
    }
    .name { font-weight: 600; color: var(--text); }
    .list { margin: 0; padding-left: 18px; color: var(--muted); }
    .list a { text-decoration: none; border-bottom: 1px solid transparent; }
    .list a:hover { border-color: currentColor; }

    .hint {
      font-size: 12px;
      color: var(--muted2);
      margin-top: 4px;
    }

    .pubList { list-style: none; margin: 0; padding: 0; }
    .pubList li { padding: 10px 0; border-bottom: 1px solid var(--border); }
    .pubCard {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      text-decoration: none;
      color: inherit;
    }
    .pubMedia {
      position: relative;
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      background: #f7f7f7;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.06);
      display: grid;
      gap: 0;
      transition: box-shadow 0.15s ease;
    }
    .pubCover,
    .pubFigure {
      width: 100%;
      height: auto;
      object-fit: cover;
      display: block;
      transform: scale(0.98);
      transition: transform 0.2s ease;
    }
    .pubCover { filter: saturate(0.95); }
    .pubFigure { border-top: 1px solid rgba(0, 0, 0, 0.08); }
    .pubBadge {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: rgba(17, 17, 17, 0.75);
      color: #fff;
      font-size: 12px;
      display: grid;
      place-items: center;
    }
    .pubCard:hover .pubMedia {
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
      transform: translateY(-1px);
      transition: box-shadow 0.15s ease, transform 0.15s ease;
    }
    .pubCard:hover .pubCover,
    .pubCard:hover .pubFigure {
      transform: scale(1.03);
    }
    .pubBody { display: grid; gap: 6px; }
    .pubMeta { color: var(--muted); font-family: ui-sans-serif, system-ui; font-size: 12px; }
    .pubAuthors { font-weight: 600; color: var(--text); }
    .status { margin-left: 8px; font-weight: 600; color: var(--text); }
    .pubTitle { font-size: 18px; line-height: 1.35; }
  </style>
</Layout>
