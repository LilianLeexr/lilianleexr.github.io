---
import Layout from "../layouts/Layout.astro";
import SiteHeader from "../components/SiteHeader.astro";
import SiteFooter from "../components/SiteFooter.astro";
import site from "../data/site.json";
import publications from "../data/publications.json";
import { getCollection, getEntryBySlug } from "astro:content";

const slugifyCategory = (s) => String(s || "").trim().toLowerCase().replace(/\s+/g, "-");

const about = await getEntryBySlug("pages", "about");
const research = await getEntryBySlug("pages", "research");
const blog = await getEntryBySlug("pages", "blog");
const technotes = await getEntryBySlug("pages", "technotes");
const life = await getEntryBySlug("pages", "life");

const sections = [
  { label: "About Me", href: "/about", summary: about?.data.summary },
  { label: "Research / Projects", href: "/research", summary: research?.data.summary },
  { label: "Blog", href: "/blog", summary: blog?.data.summary },
  { label: "TechNotes", href: "/technotes", summary: technotes?.data.summary },
  { label: "Life", href: "/life", summary: life?.data.summary },
].filter((section) => section.summary);

const allPosts = await getCollection("posts", ({ data }) => !data.draft);
const posts = allPosts
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf())
  .slice(0, 6);

const projects = await getCollection("projects");
const featuredProjects = [...projects]
  .sort((a, b) => a.data.title.localeCompare(b.data.title))
  .slice(0, 3);
---

<Layout title={site.name} description="Academic and engineering homepage">
  <div class="wrap">
    <SiteHeader />

    <main class="grid">
      <section class="feed">
        <article class="block">
          <div class="blockTitle sparkle-title">About Me</div>
          <p class="desc">{about?.data.summary}</p>
          <a class="more" href="/about">Read more →</a>
        </article>

        <article class="block">
          <div class="blockTitle sparkle-title">Research / Projects</div>
          <p class="desc">{research?.data.summary}</p>
          <ul class="list">
            {featuredProjects.map((project) => (
              <li>
                <a href={`/projects/${project.slug}`}>{project.data.title}</a>
                <span class="muted">
                  {" "}
                  — {project.data.role}, {project.data.affiliation} ({project.data.period})
                </span>
              </li>
            ))}
          </ul>
          <a class="more" href="/research">View all projects →</a>
        </article>

        <article class="block">
          <div class="blockTitle sparkle-title">Latest Writing</div>
          <ul class="postList">
            {posts.map((post) => (
              <li>
                <div class="postMeta">
                  <time datetime={post.data.date.toISOString()}>
                    {post.data.date.toISOString().slice(0, 10)}
                  </time>
                  <span class="dot">·</span>
                  <a class="cat" href={`/category/${slugifyCategory(post.data.category)}`}>
                    {post.data.category}
                  </a>
                </div>
                <a class="postTitle" href={`/posts/${post.slug}`}>
                  {post.data.title}
                </a>
              </li>
            ))}
          </ul>
          <div class="moreLinks">
            <a href="/blog">Blog →</a>
            <a href="/technotes">TechNotes →</a>
            <a href="/life">Life →</a>
          </div>
        </article>

        <article class="block">
          <div class="blockTitle sparkle-title">Publications</div>
          <ul class="pubList">
            {publications.map((pub) => (
              <li>
                <a class="pubCard" href={pub.href} target="_blank" rel="noopener">
                  <div class="pubBody">
                    <div class="pubMeta">
                      <span class="pubAuthors">{pub.authors}</span>
                      <span class="dot">·</span>
                      <span>{pub.venue}</span>
                      <span class="dot">·</span>
                      <span>{pub.year}</span>
                      <span class="status">{pub.status}</span>
                    </div>
                    <div class="pubTitle">{pub.title}</div>
                  </div>
                  <div class="pubMedia">
                    <img class="pubCover" src={pub.cover} alt={`${pub.title} cover`} />
                    <img class="pubFigure" src={pub.figure} alt={`${pub.title} figure`} />
                    <span class="pubBadge">↗</span>
                  </div>
                </a>
              </li>
            ))}
          </ul>
        </article>
      </section>

      <aside class="side">
        <div class="box section-surface">
          <div class="boxTitle sparkle-title">Profile</div>
          <div class="profile">
            <div class="avatar-wrap">
              <div class="cat-wrapper" aria-hidden="true">
                <svg class="cat" viewBox="0 0 100 60" xmlns="http://www.w3.org/2000/svg">
                  <path class="cat-body" d="M20,40 Q20,20 50,20 T80,40" />
                  <path class="cat-stripe" d="M40,22 Q45,30 40,38 M50,21 Q55,30 50,38 M60,22 Q65,30 60,38" />
                  <circle class="cat-head" cx="80" cy="35" r="12" />
                  <path class="cat-ear" d="M75,25 L70,15 L80,23 M85,25 L90,15 L80,23" />
                  <circle class="cat-eye" cx="77" cy="33" r="1.5" />
                  <circle class="cat-eye" cx="83" cy="33" r="1.5" />
                  <line class="leg leg-1" x1="30" y1="40" x2="30" y2="50" />
                  <line class="leg leg-2" x1="45" y1="40" x2="45" y2="50" />
                  <line class="leg leg-3" x1="60" y1="40" x2="60" y2="50" />
                  <line class="leg leg-4" x1="75" y1="40" x2="75" y2="50" />
                </svg>
              </div>
              <img class="avatar" src="/images/ID.jpg" alt={`${site.name} portrait`} />
            </div>
            <div>
              <p class="muted name">{site.name}</p>
              <p class="muted">{site.tagline}</p>
              <p class="muted">{site.location}</p>
            </div>
          </div>
        </div>

        <div class="box">
          <div class="boxTitle">Sections</div>
          <ul class="list">
            {sections.map((section) => (
              <li>
                <a href={section.href}>{section.label}</a>
                <div class="hint">{section.summary}</div>
              </li>
            ))}
          </ul>
        </div>

        <div class="box">
          <div class="boxTitle">Contact</div>
          <ul class="list">
            {site.social.map((item) => (
              <li>
                <a href={item.href} target={item.href.startsWith("http") ? "_blank" : undefined}>
                  {item.label}
                </a>
              </li>
            ))}
          </ul>
        </div>
      </aside>
    </main>

    <SiteFooter />
  </div>

  <style>
    .wrap {
      max-width: var(--max);
      margin: 0 auto;
      width: 100%;
    }

    .grid {
      display: grid;
      grid-template-columns: minmax(0, 1fr) 340px;
      gap: 44px;
      align-items: start;
    }

    @media (max-width: 980px) {
      .grid { grid-template-columns: 1fr; gap: 26px; }
    }

    .block {
      padding: 18px 0;
      border-bottom: 1px solid var(--border);
    }

    .blockTitle {
      font-family: ui-sans-serif, system-ui;
      font-weight: 650;
      font-size: 12px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      margin-bottom: 8px;
      color: var(--muted2);
    }

    .desc { margin: 0 0 10px; color: var(--muted); font-size: 15px; }

    .postList { list-style: none; margin: 0; padding: 0; }
    .postList li { padding: 10px 0; border-bottom: 1px solid var(--border); }

    .postMeta { color: var(--muted); font-family: ui-sans-serif, system-ui; font-size: 12px; }
    .dot { margin: 0 8px; }
    .cat { text-decoration: none; border-bottom: 1px solid transparent; }
    .cat:hover { border-color: currentColor; }

    .postTitle { display: inline-block; margin-top: 6px; text-decoration: none; font-size: 18px; }
    .postTitle:hover { text-decoration: underline; }

    .more {
      display: inline-block;
      margin-top: 10px;
      font-family: ui-sans-serif, system-ui;
      text-decoration: none;
      border-bottom: 1px solid var(--border);
      padding-bottom: 2px;
    }

    .more:hover { border-color: var(--text); }

    .moreLinks {
      display: flex;
      gap: 12px;
      margin-top: 10px;
      font-family: ui-sans-serif, system-ui;
    }

    .moreLinks a { text-decoration: none; border-bottom: 1px solid var(--border); padding-bottom: 2px; }
    .moreLinks a:hover { border-color: var(--text); }

    .side { position: sticky; top: 18px; align-self: start; }
    @media (max-width: 980px) { .side { position: static; } }

    .box { border: 1px solid var(--border); padding: 14px; margin-bottom: 14px; }
    .boxTitle {
      font-family: ui-sans-serif, system-ui;
      font-weight: 650;
      font-size: 12px;
      letter-spacing: .10em;
      text-transform: uppercase;
      margin-bottom: 10px;
      color: var(--muted2);
    }

    .muted { color: var(--muted); margin: 0 0 8px; font-size: 14px; }
    .profile {
      display: grid;
      grid-template-columns: 92px 1fr;
      gap: 12px;
      align-items: center;
    }
    .avatar-wrap {
      position: relative;
      width: 92px;
      height: 92px;
    }
    .avatar {
      width: 92px;
      height: 92px;
      border-radius: 18px;
      object-fit: cover;
      border: 1px solid var(--border);
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.08);
    }
    .cat-wrapper {
      position: absolute;
      top: -26px;
      left: -12px;
      width: 60px;
      z-index: 2;
      animation: move-and-flop 8s infinite ease-in-out;
      transform-origin: bottom center;
    }
    .cat { width: 100%; height: auto; }
    .cat-body, .cat-head, .cat-ear {
      fill: #b5b8bc;
      stroke: #4c5561;
      stroke-width: 2;
    }
    .cat-stripe {
      fill: none;
      stroke: #7c828a;
      stroke-width: 1.5;
    }
    .cat-eye { fill: #2b2f38; }
    .leg { stroke: #4c5561; stroke-width: 3; }
    .leg { animation: walk-legs 0.5s infinite alternate; }
    .leg-2, .leg-4 { animation-delay: 0.25s; }

    @keyframes walk-legs {
      from { transform: translateY(0); }
      to { transform: translateY(-2px); }
    }
    @keyframes move-and-flop {
      0% { transform: translateX(-10px) rotate(0deg); opacity: 0; }
      10% { opacity: 1; }
      40% { transform: translateX(70px) rotate(0deg); }
      45% { transform: translateX(74px) rotate(-5deg); }
      55% { transform: translateX(74px) translateY(10px) rotate(80deg); }
      60% { transform: translateX(76px) translateY(8px) rotate(75deg); }
      65% { transform: translateX(74px) translateY(10px) rotate(80deg); }
      70% { transform: translateX(76px) translateY(8px) rotate(75deg); }
      85% { transform: translateX(74px) rotate(0deg); opacity: 1; }
      100% { transform: translateX(130px) rotate(0deg); opacity: 0; }
    }
    .name { font-weight: 600; color: var(--text); }
    .list { margin: 0; padding-left: 18px; color: var(--muted); }
    .list a { text-decoration: none; border-bottom: 1px solid transparent; }
    .list a:hover { border-color: currentColor; }

    .hint {
      font-size: 12px;
      color: var(--muted2);
      margin-top: 4px;
    }

    .pubList { list-style: none; margin: 0; padding: 0; }
    .pubList li { padding: 10px 0; border-bottom: 1px solid var(--border); }
    .pubCard {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      text-decoration: none;
      color: inherit;
    }
    .pubMedia {
      position: relative;
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      background: #f7f7f7;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.06);
      display: grid;
      gap: 0;
      transition: box-shadow 0.15s ease;
    }
    .pubCover,
    .pubFigure {
      width: 100%;
      height: auto;
      object-fit: cover;
      display: block;
      transform: scale(0.98);
      transition: transform 0.2s ease;
    }
    .pubCover { filter: saturate(0.95); }
    .pubFigure { border-top: 1px solid rgba(0, 0, 0, 0.08); }
    .pubBadge {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: rgba(17, 17, 17, 0.75);
      color: #fff;
      font-size: 12px;
      display: grid;
      place-items: center;
    }
    .pubCard:hover .pubMedia {
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
      transform: translateY(-1px);
      transition: box-shadow 0.15s ease, transform 0.15s ease;
    }
    .pubCard:hover .pubCover,
    .pubCard:hover .pubFigure {
      transform: scale(1.03);
    }
    .pubBody { display: grid; gap: 6px; }
    .pubMeta { color: var(--muted); font-family: ui-sans-serif, system-ui; font-size: 12px; }
    .pubAuthors { font-weight: 600; color: var(--text); }
    .status { margin-left: 8px; font-weight: 600; color: var(--text); }
    .pubTitle { font-size: 18px; line-height: 1.35; }
  </style>
</Layout>
